<!DOCTYPE html>
<html lang="fr-FR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="CDA2111">
    <meta name="keywords" content="nutriscore, céréales, protéines">
    <meta name="description" content="Affichagede céréales venant d'une API.">
    <link rel="stylesheet" href="style.css">
    <title>Céréales</title>
</head>
<body>
    <script src="https://unpkg.com/vue@3"></script>

    <div id="app">
        <header>
            <h1>Cereals</h1>
            <form action="">
                <fieldset>
                    <legend>
                        <label for="rechercher">Rechercher</label>
                    </legend>
                    <input @input="filterByName" type="search" placeholder="Nom du céréal" id="rechercher">
                </fieldset>
                <fieldset>
                    <legend>Filtrer</legend>
                    <fieldset class="nutriscore-container">
                        <legend>
                            <label>Nutriscore</label>
                        </legend>
                        <label for="a">A</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="a" value="a">

                        <label for="b">B</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="b" value="b">

                        <label for="c">C</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="c" value="c">

                        <label for="d">D</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="d" value="d">

                        <label for="e">E</label>
                        <input @change="filterByNutriScore" type="checkbox" name="nutriscore" id="E" value="e">
                    </fieldset>
                    <div>
                        <legend>Catégorie</legend>
                        <select @change="filterByCategory" list="categorie" id="categorie" name="categorie" />
                            <option value="tous">Tous</option>
                            <option value="sans-sucre">Sans sucre</option>
                            <option value="sans-sel">Sans sel</option>
                            <option value="boost">Boost</option>
                        </select>

                    </div>
                </fieldset>
            </form>
        </header>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th class="text-left">NOM</th>
                    <th>CALORIE</th>
                    <th>PROTEINES</th>
                    <th>SEL</th>
                    <th>FIBRES</th>
                    <th>GLUCIDES</th>
                    <th>SUCRE</th>
                    <th>POTASSIUM</th>
                    <th>VITAMINES</th>
                    <th>EVALUATION</th>
                    <th>NS</th>
                    <th>DEL</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="cereal in filteredCereals" :key="cereal.id">
                    <td class="identifiant">{{ cereal.id }}</td>
                    <td class="text-left">{{ cereal.name }}</td>
                    <td>{{ cereal.calories }}</td>
                    <td>{{ cereal.protein }}</td>
                    <td>{{ cereal.sodium }}</td>
                    <td>{{ cereal.fiber }}</td>
                    <td>{{ cereal.carbo }}</td>
                    <td>{{ cereal.sugars }}</td>
                    <td>{{ cereal.potass }}</td>
                    <td>{{ cereal.vitamins }}</td>
                    <td>{{ cereal.rating }}</td>
                    <td  :class="cereal.nutriscore">{{ cereal.nutriscore }}</td>
                    <td>
                        <button @click="removeCereal(cereal)">x</button>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td></td>
                    <td>{{ countElement }}</td>
                    <td>Moyenne calories {{ avgCalories }}</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>

    <script>
    const vue = Vue.createApp({
        data() {
            return {
                cereals: null,
                filterName: '',
                filterNutri: [],
                filterCategory: 'tous',
                countElement: 0,
                avgCalories: 0
            }
        },
        methods: {
            async initCereals() {
                try {
                    this.cereals = []
                    let response = await fetch('https://arfp.github.io/tp/web/frontend/cereals/cereals.json')
                    if(response.ok) {
                        let jsonData = await response.json()
                        this.cereals = jsonData.data
                        this.cereals.forEach((cereal) => {
                            cereal.nutriscore = this.checkNutriScore(cereal)
                            for(const property in cereal) {
                                if(cereal[property] === -1)
                                    cereal[property] = null
                            }
                        });
                    }
                } catch (error) {
                    console.log(error)
                }
            },
            checkNutriScore(cereal) {
                let result
                if(cereal.rating > 80 )
                    result = 'A'
                else if(cereal.rating > 70)
                    result = 'B'
                else if(cereal.rating > 55)
                    result = 'C'
                else if(cereal.rating > 35)
                    result = 'D'
                else result = 'E'
                return result
            },
            removeCereal(cerealToDelete) {
                this.cereals = this.cereals.filter((cereal) =>
                    cereal.id != cerealToDelete.id
                )
            },
            filterByName() {
                this.filterName = event.target.value
            },
            filterByNutriScore() {
                const fielset = event.target.parentNode
                const checked = fielset.querySelectorAll('input[type=checkbox]:checked')
                let result = []
                checked.forEach((input) => result.push(input.value));
                this.filterNutri = result
            },
            filterByCategory() {
                this.filterCategory = event.target.value
            }
        },
        computed: {
            filteredCereals() {
                let result
                if(this.filterName.length > 0) {
                    result = this.cereals.filter((cereal) => cereal.name.toLowerCase().includes(this.filterName.toLowerCase()))
                } else {
                    result = this.cereals
                }
                if(this.filterNutri.length > 0) {
                    result = result.filter(cereal => this.filterNutri.includes(cereal.nutriscore.toLowerCase()))
                }
                switch (this.filterCategory) {
                    case 'sans-sucre':
                        result = this.cereals.filter((cereal) => cereal.sugars < 1 && cereal.sugars != null)
                        break
                    case 'sans-sel':
                        result = this.cereals.filter((cereal) => cereal.sodium < 50 && cereal.sodium != null)
                        break
                    case 'boost':
                        result = this.cereals.filter((cereal) => cereal.vitamins >= 25 && cereal.fiber >= 10)
                        break
                    default:
                        break
                }
                if(result != null) {
                    this.countElement = result.length
                    let tmpSumCalories = 0
                    result.forEach(cereal => {
                        tmpSumCalories += cereal.calories
                    });
                    this.avgCalories = Math.round(tmpSumCalories / this.countElement * 100) / 100
                    console.log(this.avgCalories)
                }
                return result
            }
        },
        mounted() {
            this.initCereals();
        },
    }).mount('#app')
    </script>

</body>
</html>